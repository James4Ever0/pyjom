{"version":3,"file":"watchdog.es6.umd.js","sources":["../dist/watchdog.js"],"sourcesContent":["// https://github.com/andrew-filonenko/ya-watchdog\n// https://en.wikipedia.org/wiki/Watchdog_timer\nimport { EventEmitter } from 'events';\nimport { Brolog } from 'brolog';\nexport const log = new Brolog();\nexport const VERSION = require('../package.json').version;\nexport class Watchdog extends EventEmitter {\n    /**\n     * A Timer used to detect and recover from malfunctions\n     *\n     * @class Watchdog\n     * @param {number} [defaultTimeout=60 * 1000]\n     * @param {string} [name='Bark']\n     * @example\n     * const TIMEOUT = 1 * 1000  // 1 second\n     * const dog = new watchdog(TIMEOUT)\n     *\n     * const food = { data: 'delicious' }\n     *\n     * dog.on('reset', () => console.log('reset-ed'))\n     * dog.on('feed',  () => console.log('feed-ed'))\n     *\n     * dog.feed(food)\n     * // Output: feed-ed\n     *\n     * setTimeout(function() {\n     *   dog.sleep()\n     *   console.log('dog sleep-ed. Demo over.')\n     * }, TIMEOUT + 1)\n     * // Output: reset-ed.\n     * // Output: dog sleep-ed. Demo over.\n     *\n     */\n    constructor(defaultTimeout = 60 * 1000, name = 'Bark') {\n        super();\n        this.defaultTimeout = defaultTimeout;\n        this.name = name;\n        log.verbose('Watchdog', '<%s>: constructor(name=%s, defaultTimeout=%d)', name, name, defaultTimeout);\n    }\n    version() {\n        return VERSION;\n    }\n    /**\n     * @desc       Watchdog Class Event Type\n     * @typedef    WatchdogEvent\n     * @property   { string }  feed  - Emit when feed the dog.\n     * @property   { string }  reset - Emit when timeout and reset.\n     * @property   { string }  sleep - Emit when timer is cleared out.\n     */\n    /**\n     * @desc       Watchdog Class Event Function\n     * @typedef    WatchdogListener\n     * @property   { Function }   - (food: WatchdogFood<T, D>, left: number) => void\n     */\n    /**\n     * @listens Watchdog\n     * @param   { WatchdogEvent }           event\n     * @param   { WatchdogListener<T, D> }  listener\n     * @returns { this }\n     *\n     * @example <caption>Event:reset </caption>\n     * dog.on('reset', () => console.log('reset-ed'))\n     * @example <caption>Event:feed </caption>\n     * dog.on('feed',  () => console.log('feed-ed'))\n     * @example <caption>Event:sleep </caption>\n     * dog.on('sleep',  () => console.log('sleep-ed'))\n     *\n     */\n    on(event, listener) {\n        log.verbose('Watchdog', '<%s> on(%s, listener) registered.', this.name, event);\n        super.on(event, listener);\n        return this;\n    }\n    startTimer(timeout) {\n        log.verbose('Watchdog', '<%s> startTimer()', this.name);\n        if (this.timer) {\n            throw new Error('timer already exist!');\n        }\n        this.timer = setTimeout(() => {\n            log.verbose('Watchdog', '<%s> startTimer() setTimeout() after %d', this.name, timeout);\n            this.timer = undefined; // sleep after reset\n            this.emit('reset', this.lastFood, this.lastFood && this.lastFood.timeout || this.defaultTimeout);\n        }, timeout);\n        this.timer.unref(); // should not block node quit\n        return;\n    }\n    stopTimer(sleep = false) {\n        log.verbose('Watchdog', '<%s> stopTimer()', this.name);\n        if (typeof this.timer === 'undefined') { // first time\n            log.verbose('Watchdog', '<%s> stopTimer() first run(or after sleep)', this.name);\n            return;\n        }\n        if (this.timer) {\n            clearTimeout(this.timer);\n            this.timer = null;\n        }\n        else if (!sleep) {\n            throw new Error('timer is already stoped!');\n        }\n    }\n    /**\n     * Get the left time\n     * @returns {number}\n     */\n    left() {\n        let left;\n        if (typeof this.lastFeed !== 'undefined'\n            && Number.isInteger(this.lastFeed)) {\n            // console.log('lastFeed=', this.lastFeed)\n            // console.log('timeout=', this.lastFood.timeout)\n            // console.log('Date.now()=', Date.now())\n            left = this.lastFeed + this.defaultTimeout - Date.now();\n            log.verbose('Watchdog', '<%s> timerLeft() = %d', this.name, left);\n        }\n        else {\n            left = 0;\n            log.verbose('Watchdog', '<%s> timerLeft() first feed, left=%s', this.name, left);\n        }\n        return left;\n    }\n    /**\n     * Dog Feed content\n     *\n     * @typedef    WatchdogFood\n     * @property   {D}      data     - feed content.\n     * @property   {number} timeout  - option, set timeout.\n     * @property   {T}      type     - option.\n     */\n    /**\n     * feed the dog\n     * @param {WatchdogFood} food\n     * @returns {number}\n     * @example\n     * const food = {\n     *   data:    'delicious',\n     *   timeout: 1 * 1000,\n     * }\n     * const dog = new Watchdog()\n     * dog.feed(food)\n     */\n    feed(food) {\n        // JSON.stringify, avoid TypeError: Converting circular structure to JSON\n        // https://stackoverflow.com/a/11616993/1123955\n        function replacerFactory() {\n            // Note: cache should not be re-used by repeated calls to JSON.stringify.\n            const cache = [];\n            return function (_, value) {\n                if (typeof value === 'object' && value !== null) {\n                    if (cache.indexOf(value) !== -1) {\n                        // Circular reference found, discard key\n                        return;\n                    }\n                    // Store value in our collection\n                    cache.push(value);\n                }\n                return value;\n            };\n        }\n        log.verbose('Watchdog', '<%s> feed(%s)', this.name, JSON.stringify(food, replacerFactory()));\n        if (typeof food !== 'object') {\n            /**\n             * weak typing compitable:\n             *  if user call watchdog.feed('string'), we need to pre-processs the food to a object.\n             *  or we will meet a exception: we can not set property on string type.\n             */\n            food = {\n                data: food,\n            };\n        }\n        if (!food.timeout) {\n            food.timeout = this.defaultTimeout;\n        }\n        const left = this.left();\n        this.stopTimer();\n        this.startTimer(food.timeout);\n        this.lastFeed = Date.now();\n        this.lastFood = food;\n        this.emit('feed', food, left);\n        return left;\n    }\n    /**\n     * Clear timer.\n     * @example\n     * const dog = new Watchdog()\n     * dog.sleep()\n     */\n    sleep() {\n        log.verbose('Watchdog', '<%s> sleep()', this.name);\n        this.stopTimer(true);\n        this.timer = undefined;\n        this.emit('sleep', this.lastFood, this.left());\n    }\n    /**\n     *\n     */\n    unref() {\n        log.verbose('Watchdog', '<%s> unref()', this.name);\n        if (this.timer) {\n            this.timer.unref();\n        }\n    }\n}\nexport default Watchdog;\n//# sourceMappingURL=watchdog.js.map"],"names":["Brolog","EventEmitter"],"mappings":"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"}