!function(t,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("shiftjis")):"function"==typeof define&&define.amd?define(["exports","shiftjis"],r):r((t="undefined"!=typeof globalThis?globalThis:t||self).Vmd={},t.shiftjis)}(this,(function(t,r){"use strict";function e(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function i(t,r){for(var e=0;e<r.length;e++){var i=r[e];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function n(t,r,e){return r&&i(t.prototype,r),e&&i(t,e),t}function a(t,r,e){return r in t?Object.defineProperty(t,r,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[r]=e,t}function o(t,r){(null==r||r>t.length)&&(r=t.length);for(var e=0,i=new Array(r);e<r;e++)i[e]=t[e];return i}function s(t,r){var e;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(e=function(t,r){if(t){if("string"==typeof t)return o(t,r);var e=Object.prototype.toString.call(t).slice(8,-1);return"Object"===e&&t.constructor&&(e=t.constructor.name),"Map"===e||"Set"===e?Array.from(t):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?o(t,r):void 0}}(t))||r&&t&&"number"==typeof t.length){e&&(t=e);var i=0,n=function(){};return{s:n,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,u=!1;return{s:function(){e=t[Symbol.iterator]()},n:function(){var t=e.next();return s=t.done,t},e:function(t){u=!0,a=t},f:function(){try{s||null==e.return||e.return()}finally{if(u)throw a}}}}var u,h={V1:"Vocaloid Motion Data file",V2:"Vocaloid Motion Data 0002"},f=(a(u={},h.V1,10),a(u,h.V2,20),u),y={int8_t:Int8Array,uint8_t:Uint8Array,int16_t:Int16Array,uint16_t:Uint16Array,int32_t:Int32Array,uint32_t:Uint32Array,float:Float32Array,double:Float64Array};function l(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!t)throw new Error("length is required");return Array.from(new Array(t)).map((function(){return r}))}function c(t){var e=new Uint8Array(t),i=e.indexOf(0),n=e.slice(0,-1===i?void 0:i);return r.decode(n)}function d(t){return r.encode(t)}var v=function(){function t(r){e(this,t),this.buffer=r||new ArrayBuffer(0),this.index=0}return n(t,[{key:"readArrayByConstructor",value:function(t){for(var r=this.readInt(),e=[],i=0;i<r;i++){var n=new t(this);e.push(n)}return e}},{key:"readBytes",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if("number"!=typeof t)throw new Error("readBytes failed, place check arg");if(t<=0)return"";if(this.index+t>this.buffer.byteLength)throw new Error("Stackoverflow ".concat(this.index+t," / ").concat(this.buffer.byteLength));var r=this.buffer.slice(this.index,this.index+t);return this.index=t+this.index,r}},{key:"readInt",value:function(){return this.readByType(y.uint32_t)}},{key:"readFloat",value:function(){return this.readByType(y.float)}},{key:"readString",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=this.readBytes(t);return c(r)}},{key:"readByType",value:function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,e=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(!t)throw new Error("Type is not define");var i=this.readBytes(t.BYTES_PER_ELEMENT),n=new DataView(i,0),a="get".concat(t.name.replace("Array",""));return n[a](r,e)}},{key:"readArrayByType",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:y.uint32_t,e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],n=[];if(t<0)throw new Error("Invalid array length");for(var a=0;a<t;a++)n.push(this.readByType(r,e,i));return n}},{key:"close",value:function(){this.buffer=null,this.index=0}},{key:"restBytes",get:function(){return this.buffer.byteLength-this.index}}]),t}(),m=function(){function t(){e(this,t),this.bufferList=[]}return n(t,[{key:"writeTypedFrameArray",value:function(t){var r=this,e=t.length;return this.writeInt(e),t.forEach((function(t){t.writeBuffer(r)})),this}},{key:"writeBytes",value:function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,e=new Uint8Array(Math.max(t.byteLength,r));return e.set(t),this.bufferList.push(e.buffer),this}},{key:"writeInt",value:function(t){return this.writeByType(t,y.uint32_t)}},{key:"writeFloat",value:function(t){return this.writeByType(t,y.float)}},{key:"writeString",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,e=d(t),i=new Uint8Array(r);return i.fill(253,e.length+1),i.set(e),t!==h.V1&&t!==h.V2||i.fill(0,e.length),this.bufferList.push(i.buffer),this}},{key:"writeByType",value:function(t,r){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];if(!r)throw new Error("Type is not define");var n=new DataView(new ArrayBuffer(r.BYTES_PER_ELEMENT),0),a="set".concat(r.name.replace("Array",""));return n[a](e,t,i),this.bufferList.push(n.buffer),this}},{key:"writeArrayByType",value:function(t){var r=this,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:y.uint32_t,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];if(!Array.isArray(t))throw new Error("value is not array!");return t.forEach((function(t){r.writeByType(t,e,i,n)})),this}},{key:"getArrayBuffer",value:function(){var t,r=this.bufferList.reduce((function(t,r){return t+new Uint8Array(r).length}),0),e=new Uint8Array(r),i=0,n=s(this.bufferList);try{for(n.s();!(t=n.n()).done;){var a=t.value;e.set(new Uint8Array(a),i),i+=a.byteLength}}catch(t){n.e(t)}finally{n.f()}var o=e.buffer;return this.bufferList.splice(0),o}}]),t}(),w=function(){function t(r){e(this,t),this.boneName="",this.frameTime=0,this.translation=l(3),this.rotation=l(4),this.curveX=l(16),this.curveY=l(16),this.curveZ=l(16),this.curveR=l(16),r&&(this.boneName=r.readString(15),this.frameTime=r.readInt(),this.translation=r.readArrayByType(3,y.float),this.rotation=r.readArrayByType(4,y.float),this.curveX=r.readArrayByType(16,y.uint8_t),this.curveY=r.readArrayByType(16,y.uint8_t),this.curveZ=r.readArrayByType(16,y.uint8_t),this.curveR=r.readArrayByType(16,y.uint8_t))}return n(t,[{key:"writeBuffer",value:function(t){if(!t)throw new Error("no stream!");t.writeString(this.boneName,15),t.writeInt(this.frameTime),t.writeArrayByType(this.translation,y.float),t.writeArrayByType(this.rotation,y.float),t.writeArrayByType(this.curveX,y.uint8_t),t.writeArrayByType(this.curveY,y.uint8_t),t.writeArrayByType(this.curveZ,y.uint8_t),t.writeArrayByType(this.curveR,y.uint8_t)}}]),t}(),p=function(){function t(r){e(this,t),this.frameTime=0,this.distance=0,this.position=l(3),this.rotation=l(3),this.curve=l(24),this.viewAngle=0,this.orthographic=0,r&&(this.frameTime=r.readInt(),this.distance=r.readFloat(),this.position=r.readArrayByType(3,y.float),this.rotation=r.readArrayByType(3,y.float),this.curve=r.readArrayByType(24,y.uint8_t),this.viewAngle=r.readInt(),this.orthographic=r.readInt())}return n(t,[{key:"writeBuffer",value:function(t){if(!t)throw new Error("no stream!");t.writeInt(this.frameTime),t.writeFloat(this.distance),t.writeArrayByType(this.position,y.float),t.writeArrayByType(this.rotation,y.float),t.writeInt(this.viewAngle),t.writeInt(this.orthographic)}}]),t}(),g=function(){function t(r){e(this,t),this.frameTime=0,this.rgb=[0,0,0],this.direction=[0,0,0],r&&(this.frameTime=r.readInt(),this.rgb=r.readArrayByType(3,y.float),this.direction=r.readArrayByType(3,y.float))}return n(t,[{key:"writeBuffer",value:function(t){if(!t)throw new Error("no stream!");t.writeInt(this.frameTime),t.writeArrayByType(this.rgb,y.float),t.writeArrayByType(this.direction,y.float)}}]),t}(),A=function(){function t(r){e(this,t),this.morphName="",this.frameTime=0,this.weight=0,r&&(this.morphName=r.readString(15),this.frameTime=r.readInt(),this.weight=r.readFloat())}return n(t,[{key:"writeBuffer",value:function(t){if(!t)throw new Error("no stream!");t.writeString(this.morphName,15),t.writeInt(this.frameTime),t.writeFloat(this.weight)}}]),t}(),T=function(){function t(r){if(e(this,t),this.version=h.V2,this.modelName="",this.boneFrames=[],this.morphFrames=[],this.cameraFrames=[],this.lightFrames=[],r){var i=new v(r);this.version=i.readString(30),this.modelName=i.readString(f[this.version]),this.boneFrames=i.readArrayByConstructor(w),this.morphFrames=i.readArrayByConstructor(A),this.cameraFrames=i.readArrayByConstructor(p),this.lightFrames=i.readArrayByConstructor(g),i.close()}}return n(t,[{key:"write",value:function(){var t=new m;return t.writeString(this.version,30),t.writeString(this.modelName,f[this.version]),t.writeTypedFrameArray(this.boneFrames),t.writeTypedFrameArray(this.morphFrames),t.writeTypedFrameArray(this.cameraFrames),t.writeArrayByType(this.lightFrames),t.getArrayBuffer()}},{key:"timeline",get:function(){for(var t=this,r=this.boneFrames.reduce((function(t,r){var e=r.frameTime;return Math.max(t,e)}),0),e=Object.keys(this).filter((function(t){return t.includes("Frames")})),i=[],n=function(r){var n=e.reduce((function(e,i){var n=t[i];return e[i]=n.filter((function(t){return t.frameTime===r})),e}),{frameTime:r});i.push(n)},a=0;a<r;a++)n(a);return i}}]),t}();t.BONE_NAME=["センター","上半身","首","頭","左目","右目","ﾈｸﾀｲ１","ﾈｸﾀｲ２","ﾈｸﾀｲ３","下半身","腰飾り","左髪１","左髪２","左髪３","左髪４","左髪５","左髪６","左肩","左腕","左腕捩","左ひじ","左手捩","左手首","左袖","左親指１","左親指２","左人指１","左人指２","左人指３","左中指１","左中指２","左中指３","左薬指１","左薬指２","左薬指３","左小指１","左小指２","左小指３","左ｽｶｰﾄ前","左ｽｶｰﾄ後","左足","左ひざ","左足首","右髪１","右髪２","右髪３","右髪４","右髪５","右髪６","右肩","右腕","右腕捩","右ひじ","右手捩","右手首","右袖","右親指１","右親指２","右人指１","右人指２","右人指３","右中指１","右中指２","右中指３","右薬指１","右薬指２","右薬指３","右小指１","右小指２","右小指３","右ｽｶｰﾄ前","右ｽｶｰﾄ後","右足","右ひざ","右足首","両目","前髪１","前髪２","前髪３","左目光","右目光","ﾈｸﾀｲ４","左髪７","右髪７","左つま先","右つま先","ﾈｸﾀｲＩＫ","左髪ＩＫ","右髪ＩＫ","左足ＩＫ","右足ＩＫ","左つま先ＩＫ","右つま先ＩＫ","下半身先","頭先","左目先","右目先","腰飾り先","左袖先","左手先","左親指先","左人差指先","左中指先","左薬指先","左小指先","左スカート前先","左スカート後先","右袖先","右手先","右親指先","右人差指先","右中指先","右薬指先","右小指先","右スカート前先","右スカート後先","センター先","両目先","ﾈｸﾀｲＩＫ先","左髪ＩＫ先","右髪ＩＫ先","左足ＩＫ先","右足ＩＫ先","左つま先ＩＫ先","右つま先ＩＫ先","前髪１先","前髪２先","前髪３先","左目光先","右目光先","左腕捩先","左手捩先","右腕捩先","右手捩先","左腕捩1","左腕捩2","左腕捩3","右腕捩1","右腕捩2","右腕捩3"],t.BoneFrame=w,t.CameraFrame=p,t.LightFrame=g,t.MorphFrame=A,t.VERSION=h,t.Vmd=T,t.default=T,Object.defineProperty(t,"__esModule",{value:!0})}));
